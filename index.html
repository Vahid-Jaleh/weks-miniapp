<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WEKS Tap-To-Math</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: Arial, sans-serif; background:#111; color:#fff; margin:0; padding:24px; text-align:center; }
    h1 { margin: 0 0 8px; display:flex; align-items:center; gap:10px; justify-content:center; }
    .logo { width:28px; height:28px; border-radius:6px; background:#ffd54a; display:inline-block; }

    .balance { font-size:18px; margin:4px 0 10px; }
    .sub { opacity:.85; margin-bottom:14px; }

    /* Progress bar */
    .bar-wrap { margin: 0 auto 16px; max-width:420px; background:#1c1c1c; border-radius:12px; padding:8px 10px; box-shadow:0 4px 14px rgba(0,0,0,.35); }
    .bar-label { display:flex; justify-content:space-between; font-size:13px; opacity:.9; margin-bottom:6px; }
    .bar { position:relative; width:100%; height:12px; background:#2a2a2a; border-radius:999px; overflow:hidden; }
    .fill { position:absolute; left:0; top:0; bottom:0; width:0%; border-radius:999px;
      background: linear-gradient(90deg,#ffe16f,#ffc22a);
      box-shadow: inset 0 0 6px rgba(0,0,0,.35), 0 0 10px rgba(255,194,42,.45);
      transition: width .35s ease; }

    .card { margin:0 auto; max-width:420px; background:#1c1c1c; padding:20px; border-radius:14px; box-shadow:0 6px 22px rgba(0,0,0,.5); }
    .q { font-size:34px; margin:18px 0; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    /* Gold sheen button */
    .btn { padding:14px 10px; border:0; border-radius:12px; font-size:18px; cursor:pointer; color:#111;
      background: linear-gradient(180deg,#ffe16f,#ffc22a);
      box-shadow: 0 6px 20px rgba(255,194,42,.35);
      position:relative; overflow:hidden;
    }
    .btn:active { transform: translateY(1px); }
    .btn::after{
      content:""; position:absolute; top:-100%; left:-50%; width:80%; height:300%;
      background: linear-gradient(120deg, rgba(255,255,255,.0) 0%, rgba(255,255,255,.4) 50%, rgba(255,255,255,.0) 100%);
      transform: rotate(20deg); animation: sheen 3s infinite;
    }
    @keyframes sheen{ 0%{left:-80%} 60%{left:120%} 100%{left:120%} }

    .meta { margin:14px 0 4px; font-size:14px; opacity:.85; }
    .ok { color:#6ee78c; }
    .bad { color:#ff7a7a; }
    .muted { opacity:.7; }
    .claim { margin:18px auto 0; width:100%; max-width:420px; display:block; }
  </style>
</head>
<body>
  <h1><span class="logo"></span> WEKS <b>Tap-To-Math</b></h1>
  <div id="balance" class="balance" data-v="0">💰 Balance: …</div>

  <!-- Daily progress bar -->
  <div class="bar-wrap">
    <div class="bar-label">
      <span>Daily progress</span>
      <span id="remText">0 / 100</span>
    </div>
    <div class="bar">
      <div id="fill" class="fill"></div>
    </div>
  </div>

  <div class="sub">Solve, stack answers, then <b>Claim</b> to earn coins. You can keep practicing after the cap, but extra answers won’t add coins.</div>

  <div class="card">
    <div class="meta">Correct: <span id="c">0</span> • Wrong: <span id="w">0</span></div>
    <div id="q" class="q">Loading…</div>
    <div class="grid" id="answers"></div>
    <div id="flash" class="meta"></div>
  </div>

  <button id="claim" class="btn claim">CLAIM & CLOSE</button>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();
    try { tg.MainButton.hide(); } catch {}

    const alertBox = (m) => { try { tg.showAlert(m); } catch { alert(m); } };

    /* 🎉 Confetti (no libs) */
    function burst(x = window.innerWidth / 2, y = 120, n = 18) {
      const c = document.createElement('canvas');
      Object.assign(c.style, { position: 'fixed', left: 0, top: 0, pointerEvents: 'none', zIndex: 9999 });
      const dpr = window.devicePixelRatio || 1;
      c.width = innerWidth * dpr; c.height = innerHeight * dpr;
      const g = c.getContext('2d'); g.scale(dpr, dpr);
      document.body.appendChild(c);

      const parts = Array.from({ length: n }, () => ({
        x, y,
        r: Math.random() * 2 + 2,
        vx: (Math.random() * 2 - 1) * 4,
        vy: (Math.random() * -3 - 3),
        col: `hsl(${40 + Math.floor(Math.random() * 50)} 100% 60%)`,
        life: 60
      }));

      (function loop() {
        g.clearRect(0, 0, innerWidth, innerHeight);
        parts.forEach(p => {
          p.x += p.vx; p.y += p.vy; p.vy += 0.12; p.life--;
          g.fillStyle = p.col; g.beginPath(); g.arc(p.x, p.y, p.r, 0, Math.PI * 2); g.fill();
        });
        if (parts.some(p => p.life > 0)) requestAnimationFrame(loop); else c.remove();
      })();
    }

    /* Persistent local progress (resets daily) */
    const STORAGE_KEY = "weks_progress_v1";
    const todayStr = () => new Date().toISOString().slice(0,10);
    function loadProgress() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { day: todayStr(), correct: 0, wrong: 0 };
        const obj = JSON.parse(raw);
        if (obj.day !== todayStr()) return { day: todayStr(), correct: 0, wrong: 0 };
        return obj;
      } catch { return { day: todayStr(), correct: 0, wrong: 0 }; }
    }
    function saveProgress() { localStorage.setItem(STORAGE_KEY, JSON.stringify(progress)); }
    function resetProgressForToday() {
      progress = { day: todayStr(), correct: 0, wrong: 0 };
      saveProgress(); updateUI(); pendingBalance = 0; updateBalanceDisplay();
    }

    let progress = loadProgress();
    let current = null;

    /* Live balance (server + pending) */
    let serverBalance = 0;   // from KV
    let pendingBalance = 0;  // local (10 per correct)

    /* Server daily base (already used before this session) */
    let serverTodayUsed = 0;
    const DAILY_CAP = 100;

    /* Animated coin counter */
    function animateCoins(el, from, to, dur=600){
      const start = performance.now();
      function tick(t){
        const p = Math.min(1, (t-start)/dur);
        const eased = 1 - Math.pow(1-p, 3);
        const val = Math.round(from + (to-from)*eased);
        el.textContent = `💰 Balance: ${val}`;
        if(p<1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    /* UI helpers */
    function updateUI(){
      document.getElementById("c").textContent = progress.correct;
      document.getElementById("w").textContent = progress.wrong;
      updateBar();
    }
    function updateBalanceDisplay(){
      const el = document.getElementById("balance");
      const prev = Number(el.dataset.v || 0);
      const next = serverBalance + pendingBalance;
      el.dataset.v = String(next);
      animateCoins(el, prev, next);
    }
    function updateBar(){
      const localUsed = progress.correct + progress.wrong;
      const used = Math.min(DAILY_CAP, serverTodayUsed + localUsed);
      const pct = (used / DAILY_CAP) * 100;
      document.getElementById("fill").style.width = `${pct}%`;
      document.getElementById("remText").textContent = `${used} / ${DAILY_CAP}`;
    }
    function flash(text, good){
      const f = document.getElementById("flash");
      f.textContent = text;
      f.className = "meta " + (good===true?"ok":good===false?"bad":"");
    }

    /* Quiz */
    function randint(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function newQuestion(){
      const ops = ["+","-","×","÷"];
      const op = ops[randint(0,ops.length-1)];
      let a = randint(2,25), b = randint(2,25), ans=0;
      if(op==="+"){ ans = a+b; }
      else if(op==="-"){ if(b>a){ [a,b]=[b,a]; } ans=a-b; }
      else if(op==="×"){ ans=a*b; }
      else if(op==="÷"){ ans = randint(2,12); b = randint(2,12); a = ans*b; }
      current = { text: `${a} ${op} ${b} = ?`, ans };
      document.getElementById("q").textContent = current.text;

      const opts = new Set([ans]);
      while(opts.size<4){
        const delta = randint(1,10), sign = Math.random()<0.5?-1:1;
        opts.add(ans + sign*delta);
      }
      const shuffled = Array.from(opts).sort(()=>Math.random()-0.5);

      const box = document.getElementById("answers");
      box.innerHTML = "";
      shuffled.forEach(v=>{
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = v;
        btn.onclick = ()=>choose(v);
        box.appendChild(btn);
      });
      flash("");
    }

    function choose(v){
      if(!current) return;
      if(Number(v)===current.ans){
        progress.correct++;
        pendingBalance += 10; // instant local reward
        flash("Correct! +10 coins (pending) ✅", true);
        tg.HapticFeedback.notificationOccurred("success");
        burst();                       // 🎉 small confetti on correct
      } else {
        progress.wrong++;
        flash(`Oops! Correct was ${current.ans}`, false);
        tg.HapticFeedback.notificationOccurred("error");
      }
      saveProgress();
      updateUI();
      updateBalanceDisplay();
      newQuestion();
    }

    /* Fetch balance + today used from server */
    async function fetchBalanceAndToday() {
      try {
        const resp = await fetch("https://weks-bot.vercel.app/api/balance", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ initData: tg.initData || "" })
        });
        const data = await resp.json();
        if (data.ok) {
          serverBalance = data.balance;
          serverTodayUsed = data.todayUsed || 0;
          pendingBalance = progress.correct * 10; // restore pending
          const balEl = document.getElementById("balance");
          balEl.dataset.v = String(serverBalance); // base for first animation
          updateBalanceDisplay();
          updateBar();
        } else {
          document.getElementById("balance").textContent = "💰 Balance: error";
        }
      } catch {
        document.getElementById("balance").textContent = "💰 Balance: error";
      }
    }

    /* Claim */
    async function claim() {
      try {
        const resp = await fetch("https://weks-bot.vercel.app/api/claim", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            initData: tg.initData || "",
            correct: progress.correct,
            wrong: progress.wrong
          })
        });
        const data = await resp.json();
        if (!data.ok) {
          alertBox("Claim failed: " + (data.error || "Unknown error"));
          return;
        }

        if (data.message === "DAILY_CAP_REACHED") {
          alertBox(
            `🎉 You reached the daily cap of ${data.dailyCap}.\n` +
            `Keep practicing! Answers won’t add coins until tomorrow.\n\n` +
            `Balance: ${data.balance}`
          );
          // (no big confetti on cap)
        } else {
          alertBox(
            `✅ Claimed ${data.creditedCorrect} correct (+${data.coins} coins).\n` +
            `❌ Wrong: ${data.creditedWrong}\n` +
            `Today used: ${data.today}/${data.dailyCap}\n` +
            `Balance: ${data.balance}`
          );
          burst(window.innerWidth / 2, 140, 32);   // 🎉 big win confetti on success
        }

        // Sync with server truth
        serverBalance = data.balance;
        serverTodayUsed = data.today; // used today after claim
        resetProgressForToday();      // clears local pending
        updateBar();
        updateBalanceDisplay();

        setTimeout(()=>{ try { tg.close(); } catch {} }, 150);
      } catch (e) {
        console.error(e);
        alertBox("Could not send claim. Check your internet and try again.");
      }
    }

    document.getElementById("claim").onclick = claim;

    /* Init */
    fetchBalanceAndToday();
    newQuestion();
    updateUI();
  </script>
</body>
</html>
