<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WEKS Tap-To-Math</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: Arial, sans-serif; background:#111; color:#fff; margin:0; padding:24px; text-align:center; }
    h1 { margin: 0 0 8px; display:flex; align-items:center; gap:10px; justify-content:center; }
    .logo { width:28px; height:28px; border-radius:6px; background:#ffd54a; display:inline-block; }
    .sub { opacity:.85; margin-bottom:20px; }
    .card { margin:0 auto; max-width:420px; background:#1c1c1c; padding:20px; border-radius:14px; box-shadow:0 6px 22px rgba(0,0,0,.5); }
    .q { font-size:34px; margin:18px 0; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .btn { padding:14px 10px; border:0; border-radius:12px; font-size:18px; cursor:pointer; background:#ffd54a; color:#111; }
    .btn:active { transform: translateY(1px); }
    .meta { margin:14px 0 4px; font-size:14px; opacity:.85; }
    .ok { color:#6ee78c; }
    .bad { color:#ff7a7a; }
    .muted { opacity:.7; }
    .claim { margin:18px auto 0; width:100%; max-width:420px; display:block; }
    .balance { font-size:18px; margin-bottom:10px; }
  </style>
</head>
<body>
  <h1><span class="logo"></span> WEKS <b>Tap-To-Math</b></h1>
  <div id="balance" class="balance">ðŸ’° Balance: â€¦</div>
  <div class="sub">Solve, stack correct answers, then <b>Claim</b> to get coins.</div>

  <div class="card">
    <div class="meta">Correct: <span id="c">0</span> â€¢ Wrong: <span id="w">0</span></div>
    <div id="q" class="q">Loadingâ€¦</div>
    <div class="grid" id="answers"></div>
    <div class="meta muted">Daily cap: 100 Q â†’ +10 coins each</div>
    <div id="flash" class="meta"></div>
  </div>

  <button id="claim" class="btn claim">CLAIM & CLOSE</button>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();
    try { tg.MainButton.hide(); } catch {}

    const alertBox = (m) => { try { tg.showAlert(m); } catch { alert(m); } };

    // ---------- persistence ----------
    const STORAGE_KEY = "weks_progress_v1";
    const todayStr = () => new Date().toISOString().slice(0,10);

    function loadProgress() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { day: todayStr(), correct: 0, wrong: 0 };
        const obj = JSON.parse(raw);
        if (obj.day !== todayStr()) return { day: todayStr(), correct: 0, wrong: 0 };
        return obj;
      } catch { return { day: todayStr(), correct: 0, wrong: 0 }; }
    }
    function saveProgress() { localStorage.setItem(STORAGE_KEY, JSON.stringify(progress)); }
    function resetProgressForToday() {
      progress = { day: todayStr(), correct: 0, wrong: 0 };
      saveProgress(); updateUI();
    }

    let progress = loadProgress();

    // ---------- quiz ----------
    let current = null;
    function randint(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function newQuestion(){
      const ops = ["+","-","Ã—","Ã·"];
      const op = ops[randint(0,ops.length-1)];
      let a = randint(2,25), b = randint(2,25), ans=0;
      if(op==="+"){ ans = a+b; }
      else if(op==="-"){ if(b>a){ [a,b]=[b,a]; } ans=a-b; }
      else if(op==="Ã—"){ ans=a*b; }
      else if(op==="Ã·"){ ans = randint(2,12); b = randint(2,12); a = ans*b; }
      current = { text: `${a} ${op} ${b} = ?`, ans };
      document.getElementById("q").textContent = current.text;

      const opts = new Set([ans]);
      while(opts.size<4){
        const delta = randint(1,10), sign = Math.random()<0.5?-1:1;
        opts.add(ans + sign*delta);
      }
      const shuffled = Array.from(opts).sort(()=>Math.random()-0.5);

      const box = document.getElementById("answers");
      box.innerHTML = "";
      shuffled.forEach(v=>{
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = v;
        btn.onclick = ()=>choose(v);
        box.appendChild(btn);
      });
      flash(""); updateUI();
    }

    function flash(text, good){
      const f = document.getElementById("flash");
      f.textContent = text;
      f.className = "meta " + (good===true?"ok":good===false?"bad":"");
    }
    function updateUI(){
      document.getElementById("c").textContent = progress.correct;
      document.getElementById("w").textContent = progress.wrong;
    }

    function choose(v){
      if(!current) return;
      if(Number(v)===current.ans){
        progress.correct++; flash("Correct! Ready to claim later âœ…", true);
        tg.HapticFeedback.notificationOccurred("success");
      } else {
        progress.wrong++; flash(`Oops! Correct was ${current.ans}`, false);
        tg.HapticFeedback.notificationOccurred("error");
      }
      saveProgress(); updateUI(); newQuestion();
    }

    // ---------- balance fetch ----------
    async function fetchBalance() {
      try {
        const resp = await fetch("https://weks-bot.vercel.app/api/balance", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ initData: tg.initData || "" })
        });
        const data = await resp.json();
        if (data.ok) {
          document.getElementById("balance").textContent = `ðŸ’° Balance: ${data.balance}`;
        } else {
          document.getElementById("balance").textContent = "ðŸ’° Balance: error";
        }
      } catch {
        document.getElementById("balance").textContent = "ðŸ’° Balance: error";
      }
    }

    // ---------- claim ----------
    async function claim() {
      try {
        const resp = await fetch("https://weks-bot.vercel.app/api/claim", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ initData: tg.initData || "", correct: progress.correct })
        });
        const data = await resp.json();
        if (!data.ok) {
          alertBox("Claim failed: " + (data.error || "Unknown error"));
          return;
        }
        const msg = data.message === "DAILY_CAP_REACHED"
          ? `âœ”ï¸ Daily cap reached (${data.dailyCap}/day).`
          : `âœ… Claimed ${data.creditedQ} answers (+${data.coins} coins).`;
        alertBox(`${msg}\nToday: ${data.today}/${data.dailyCap}\nBalance: ${data.balance}`);

        // Reset local progress + refresh balance
        resetProgressForToday();
        fetchBalance();

        setTimeout(()=>{ try { tg.close(); } catch {} }, 150);
      } catch (e) {
        console.error(e);
        alertBox("Could not send claim. Check your internet and try again.");
      }
    }

    document.getElementById("claim").onclick = claim;

    // init
    fetchBalance();
    newQuestion();
  </script>
</body>
</html>
