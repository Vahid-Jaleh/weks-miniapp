<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1"
  />
  <title>WEKS Tap-To-Math</title>
  <meta name="theme-color" content="#0f1116">

  <!-- Optional PWA hooks (safe to keep; if you don't use a SW/manifest it's fine) -->
  <link rel="manifest" href="manifest.webmanifest" />

  <style>
    :root{
      --bg:#0f1116;
      --card:#151922;
      --text:#e9edf2;
      --muted:#a6b0c3;
      --accent:#ffd54d;
      --chip:#2b2f38;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:radial-gradient(1000px 600px at 20% -10%, #1a2030 0%, #0f1116 60%),
                 radial-gradient(800px 400px at 120% 0%, #111825 0%, #0f1116 70%);
      color:var(--text);
    }

    /* Header */
    .app-shell{max-width:980px; margin:auto; padding:16px; padding-top:10px;}
    .app-header{position:relative; display:flex; align-items:center; gap:10px; justify-content:space-between}
    .left-head{display:flex; align-items:center; gap:10px; min-width:0}
    .app-title{
      font-size: clamp(16px, 2.8vw, 18px); /* smaller per request */
      font-weight:800; letter-spacing:.3px; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .header-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .chip{
      border:0; border-radius:999px; padding:6px 10px; font-weight:700; font-size:12px;
      background:var(--chip); color:#fff; box-shadow:0 2px 6px rgba(0,0,0,.25); cursor:pointer
    }
    .icon-btn{ font-size:22px; background:transparent; border:0; padding:6px; color:var(--text); cursor:pointer }

    /* Overflow menu ("⋯") */
    .overflow {
      position:absolute; right:6px; top:48px; background:#1e1f26; color:#fff;
      border-radius:12px; padding:6px; box-shadow:0 8px 24px rgba(0,0,0,.35); min-width:180px; z-index:1000;
    }
    .overflow.hidden { display:none; }
    .overflow button {
      display:block; width:100%; text-align:left; padding:10px 14px; background:none; border:0; color:#fff; cursor:pointer;
    }
    .overflow button:active { background:rgba(255,255,255,.08); }

    /* Balance card */
    .top-strip{display:flex; align-items:center; gap:10px; margin-top:10px}
    .balance-card{
      background:linear-gradient(180deg, #171c28 0%, #141923 100%);
      border-radius:16px; padding:10px 14px; display:flex; align-items:center; gap:8px; box-shadow:0 6px 18px rgba(0,0,0,.25)
    }
    .coin{width:22px; height:22px; border-radius:50%; background:radial-gradient(#ffd54d 40%, #f4a300 65%, #b87400 100%); box-shadow:0 2px 6px rgba(0,0,0,.35)}
    .balance-val{font-weight:800; font-size:16px}
    .small-muted{color:var(--muted); font-size:12px}

    /* Main card */
    .card{
      background:linear-gradient(180deg,#151a25,#121722);
      border-radius:18px; padding:16px; margin-top:16px; box-shadow:0 10px 26px rgba(0,0,0,.4);
      border:1px solid rgba(255,255,255,.04)
    }
    .qtext{font-size:20px; font-weight:800; margin:0 0 12px}
    .answers{display:grid; grid-template-columns:1fr; gap:10px}
    .btn{
      border:0; border-radius:14px; padding:14px; font-weight:800; font-size:16px; cursor:pointer;
      background:linear-gradient(180deg,#1b2230,#121826); color:#e7eef8;
      box-shadow:0 4px 12px rgba(0,0,0,.25);
      text-align:left;
    }
    .btn:active{transform:translateY(1px)}
    .btn.correct{ outline:2px solid rgba(0,255,120,.4) }
    .btn.wrong{   outline:2px solid rgba(255,80,80,.4) }

    /* Flying coin */
    .fly-coin {
      position: fixed; width: 42px; height: 42px; pointer-events: none; z-index: 9999;
      background: radial-gradient(#ffd54d 40%, #f4a300 65%, #b87400 100%); border-radius: 50%;
      box-shadow: 0 6px 14px rgba(0,0,0,.25); transform: translate(-50%,-50%) scale(1);
    }

    /* Leaderboard modal */
    .modal.hidden { display:none; }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:10000; display:grid; place-items:center; padding:12px}
    .modal-card { width:min(540px, 92vw); background:#111318; color:#fff; border-radius:16px; padding:14px; border:1px solid rgba(255,255,255,.06) }
    .modal-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
    .lb-list { display:grid; gap:8px; max-height:60vh; overflow:auto; margin-top:6px }
    .lb-row { display:flex; justify-content:space-between; padding:10px 12px; background:#1a1f27; border-radius:12px; }

    /* Footer buffer for mobile gesture bars */
    .spacer{height:24px}
  </style>
</head>
<body>
  <!-- Sounds -->
  <audio id="sfx-correct" preload="auto" src="assets/sfx/correct_applause_shimmer.mp3"></audio>
  <audio id="sfx-wrong"   preload="auto" src="assets/sfx/wrong_buzzer_soft.mp3"></audio>

  <div class="app-shell">
    <!-- Header -->
    <div class="app-header">
      <div class="left-head">
        <h1 class="app-title">WEKS Tap-To-Math</h1>
      </div>
      <div style="display:flex; align-items:center; gap:8px">
        <div class="header-actions">
          <button id="btn-invite" class="chip">Invite Friend</button>
          <button id="btn-leaderboard" class="chip">Leaderboard</button>
        </div>
        <button id="btn-overflow" class="icon-btn" aria-label="More">⋯</button>
        <div id="overflow-menu" class="overflow hidden" role="menu" aria-label="More options">
          <button id="mi-add-to-screen" role="menuitem">Add game to screen</button>
        </div>
      </div>
    </div>

    <!-- Top strip -->
    <div class="top-strip">
      <div class="balance-card" title="Your total coins">
        <div class="coin" aria-hidden="true"></div>
        <div class="balance-val"><span id="balanceValue">0</span> coins</div>
      </div>
      <div class="small-muted" id="streakInfo" style="margin-left:auto">Streak: <strong id="streakVal">0</strong></div>
    </div>

    <!-- Main quiz card (demo content; replace with your generator) -->
    <div class="card">
      <p class="qtext" id="qtext">What is 7 × 6 ?</p>
      <div class="answers" id="answers">
        <!-- Buttons generated by JS -->
      </div>
    </div>

    <div class="spacer"></div>
  </div>

  <!-- Leaderboard modal -->
  <div id="lb-modal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Leaderboard">
    <div class="modal-card">
      <div class="modal-head">
        <strong>Leaderboard</strong>
        <button id="lb-close" class="icon-btn" aria-label="Close">✕</button>
      </div>
      <div id="lb-list" class="lb-list"></div>
    </div>
  </div>

  <script>
    // ===== Telegram WebApp context (safe if not present) =====
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    try { tg && tg.expand(); } catch(e){}

    // ===== Sounds (improved feel) =====
    const sfxCorrect = document.getElementById('sfx-correct');
    const sfxWrong   = document.getElementById('sfx-wrong');
    [sfxCorrect, sfxWrong].forEach(a => { if(a){ a.volume = 0.55; a.playbackRate = 1.0; }});
    function playCorrectSfx(){ try{ sfxCorrect.currentTime = 0; sfxCorrect.play(); }catch(e){} }
    function playWrongSfx(){   try{ sfxWrong.currentTime   = 0; sfxWrong.play();   }catch(e){} }

    // ===== Balance / streak storage =====
    const BALANCE_KEY = 'weks_balance';
    const STREAK_KEY  = 'weks_streak';
    const balanceEl = document.getElementById('balanceValue');
    const streakEl  = document.getElementById('streakVal');

    function getBalance(){ return +(localStorage.getItem(BALANCE_KEY) || 0); }
    function setBalance(v){ localStorage.setItem(BALANCE_KEY, String(v)); balanceEl.textContent = v.toLocaleString(); }
    function incrementBalance(delta){
      const v = getBalance() + delta;
      setBalance(v);
      // bump animation
      balanceEl.parentElement.animate([{transform:'scale(1.0)'},{transform:'scale(1.08)'},{transform:'scale(1.0)'}], {duration:220, easing:'ease-out'});
    }
    function getStreak(){ return +(localStorage.getItem(STREAK_KEY) || 0); }
    function setStreak(v){ localStorage.setItem(STREAK_KEY, String(v)); streakEl.textContent = v; }

    setBalance(getBalance());
    setStreak(getStreak());

    // ===== Flying coin animation (bigger, nicer) =====
    function flyCoin(fromEl, toEl) {
      if(!fromEl || !toEl) return;
      const from = fromEl.getBoundingClientRect();
      const to   = toEl.getBoundingClientRect();
      const coin = document.createElement('div');
      coin.className = 'fly-coin';
      document.body.appendChild(coin);

      const startX = from.left + from.width/2;
      const startY = from.top  + from.height/2;
      const endX   = to.left + to.width/2;
      const endY   = to.top  + 6; // near top of balance
      const ctrlY  = Math.min(startY, endY) - 120; // arc height

      const duration = 550; // ms
      const start    = performance.now();

      (function animate(now){
        const t = Math.min(1, (now - start)/duration);
        const e = 1 - Math.pow(1 - t, 3); // easeOutCubic

        const x = startX + (endX - startX) * e;
        const y = (1 - e)*(1 - e)*startY + 2*(1 - e)*e*ctrlY + e*e*endY;
        const scale = 1 + 0.25 * (1 - e); // starts bigger, shrinks slightly
        coin.style.left = x + 'px';
        coin.style.top  = y + 'px';
        coin.style.transform = `translate(-50%,-50%) scale(${scale})`;

        if (t < 1) requestAnimationFrame(animate);
        else coin.remove();
      })(start);
    }

    // ===== Overflow ("Add game to screen") =====
    const overflowBtn  = document.getElementById('btn-overflow');
    const overflowMenu = document.getElementById('overflow-menu');
    const addBtn       = document.getElementById('mi-add-to-screen');
    let deferredPrompt = null;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    overflowBtn.addEventListener('click', () => {
      overflowMenu.classList.toggle('hidden');
    });
    document.addEventListener('click', (e)=>{
      if(!overflowMenu.contains(e.target) && e.target !== overflowBtn){
        overflowMenu.classList.add('hidden');
      }
    });

    addBtn.addEventListener('click', async () => {
      overflowMenu.classList.add('hidden');
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt = null;
        return;
      }
      if (tg) {
        tg.showPopup({
          title: "Add WEKS quickly",
          message:
            "Inside Telegram you can:\n• Pin this bot to the top of your chat list\n• Add the bot to Favorites for quick access\n• Or create a shortcut from Telegram settings",
          buttons: [{id:"ok", type:"close", text:"Got it"}]
        });
        return;
      }
      alert("Add to Home Screen is not available in this environment.");
    });

    // ===== Invite Friend & Leaderboard =====
    const inviteBtn = document.getElementById('btn-invite');
    const lbBtn     = document.getElementById('btn-leaderboard');
    const lbModal   = document.getElementById('lb-modal');
    const lbClose   = document.getElementById('lb-close');
    const lbList    = document.getElementById('lb-list');

    inviteBtn.addEventListener('click', () => {
      const botLink = "https://t.me/YourBotUsername"; // TODO: set real link
      const shareText = encodeURIComponent("Join me on WEKS Tap-To-Math and earn coins!");
      const url = `https://t.me/share/url?url=${encodeURIComponent(botLink)}&text=${shareText}`;
      if (tg) tg.openTelegramLink(url); else window.open(url, '_blank');
    });

    function getLeaderboardData() {
      // Replace with your backend later. For now, show the current user as a demo row.
      const meName = tg?.initDataUnsafe?.user?.first_name
                   ? `${tg.initDataUnsafe.user.first_name}${tg.initDataUnsafe.user.last_name ? ' ' + tg.initDataUnsafe.user.last_name : ''}`
                   : "You";
      const me = { name: meName, coins: getBalance() };

      // Sample peers (static) — replace with real data or remove
      const peers = [
        { name: "Aiden", coins: 4320 },
        { name: "Aaron", coins: 2900 },
        { name: "Maya",  coins: 1260 },
      ];
      const rows = [me, ...peers].sort((a,b)=>b.coins-a.coins).slice(0,50);
      return rows;
    }

    function renderLeaderboard() {
      const rows = getLeaderboardData();
      lbList.innerHTML = rows.length
        ? rows.map((r,i)=> `<div class="lb-row"><span>#${i+1} — ${r.name}</span><strong>${r.coins.toLocaleString()} coins</strong></div>`).join('')
        : `<div class="lb-row"><em>No data yet. Play a bit and invite friends!</em></div>`;
    }

    lbBtn.addEventListener('click', () => { renderLeaderboard(); lbModal.classList.remove('hidden'); });
    lbClose.addEventListener('click', () => lbModal.classList.add('hidden'));
    lbModal.addEventListener('click', (e) => { if (e.target === lbModal) lbModal.classList.add('hidden'); });

    // ===== Demo quiz wiring (replace with your real generator) =====
    const qtextEl = document.getElementById('qtext');
    const answersEl = document.getElementById('answers');

    const demoQ = {
      text: "What is 7 × 6 ?",
      options: [42, 48, 56, 36],
      correctIndex: 0
    };

    function renderQuestion(q){
      qtextEl.textContent = q.text;
      answersEl.innerHTML = '';
      q.options.forEach((op, idx) => {
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = op;
        b.addEventListener('click', () => handleAnswer(idx === q.correctIndex, b));
        answersEl.appendChild(b);
      });
    }

    function handleAnswer(isCorrect, buttonEl){
      const buttons = [...answersEl.querySelectorAll('.btn')];
      buttons.forEach(b => b.disabled = true);

      if(isCorrect){
        buttonEl.classList.add('correct');
        playCorrectSfx();

        // big coin fly to balance
        const balanceNode = document.querySelector('.balance-val');
        flyCoin(buttonEl, balanceNode);

        // increment balance & streak
        incrementBalance(10);
        setStreak(getStreak()+1);

      } else {
        buttonEl.classList.add('wrong');
        playWrongSfx();
        setStreak(0);
      }

      // Next question demo (same question after short pause)
      setTimeout(()=>{
        buttons.forEach(b => b.classList.remove('correct','wrong'));
        buttons.forEach(b => b.disabled = false);
        // Here call your real "next question" generator. For demo we shuffle answers.
        demoQ.options.sort(()=>Math.random()-0.5);
        demoQ.correctIndex = demoQ.options.indexOf(42);
        renderQuestion(demoQ);
      }, 750);
    }

    // Initial render
    renderQuestion(demoQ);
  </script>
</body>
</html>
